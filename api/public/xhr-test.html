<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>üî¨ XHR Test</title>
        <script>
            window.onload =()=>{
                var start = new Date(), stop;
                console.info(`‚ÑπÔ∏è  Starting calls`);
                Promise.all([
                    atomicTestCase('0'),
                    atomicTestCase('1'),
                    atomicTestCase('2')
                ]).then(done=>{
                    stop = new Date();
                    console.info(`‚è±  Round time: ${stop.valueOf() - start.valueOf()} ms`);
                });
            };
            $.ajax = ajax;
            async function atomicTestCase(i) {
                var start, stop, testUriNode = $(`#test-uri-${i}`), testBodyNode = $(`#test-body-${i}`),
                methodAndUri = testUriNode.innerText.split(/\s+/g),
                method = methodAndUri[0],
                uri = methodAndUri[1] || (method = 'GET' && methodAndUri[0]),
                resultHeadingNode = $(`#result-heading-${i}`),
                resultNode = $(`#result-${i}`),
                req, result;
                try {
                    req = {uri:uri,method:method};
                    if (testBodyNode) req.body = testBodyNode.innerText;
                    start = new Date();
                    result = await ajax(req);
                    stop = new Date();
                    console.info(`‚è±  ${req.method} ${req.uri} took ${stop.valueOf() - start.valueOf()} ms`);
                    resultHeadingNode.innerText = `‚úÖ Complete`;
                    resultNode.innerText = result;
                }
                catch(e) {

                    resultHeadingNode.innerText = `‚ùå Errored`;
                    resultNode.innerText = result || typeof e === 'string'?e:e.message?e.message:JSON.stringify(e, null, ' ');
                }
            }
            async function ajax (options) {
                if (typeof options === 'string')
                    options = { uri:options };
                if (!options) options = {};
                if (!options.method) options.method = 'get';
                return new Promise((done,error)=>{
                    options.method = options.method.toUpperCase();
                    // https://www.w3schools.com/xml/ajax_intro.asp
                    var xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function() {
                        if (this.readyState == 4 /*done*/) {
                            if (this.status >= 200 && this.status < 500)
                                done(this.response);
                            else error(this.response);
                        }
                    };
                    xhttp.open(options.method, options.uri, true);
                    xhttp.withCredentials = true;
                    xhttp.setRequestHeader('Content-type','application/json');
                    if (options.data||options.payload||options.body)
                        xhttp.send(options.data||options.payload||options.body);
                    else xhttp.send();
                });
            }
            function $ (selector) {
                switch(selector.charAt(0)) {
                    case '#': return document.getElementById(selector.substring(1));
                    default: return null;
                } 
            }
        </script>
        <style>
            body { font-family: sans-serif; }
        </style>
    </head>
    <body>
        <h1>
            üî¨  XHR Test
        </h1>

        <h2>‚ÑπÔ∏è <span id="test-uri-0">POST http://localhost:4200/api/1/users/login</span></h2>
        <pre id="test-body-0">{"username":"system","password":"pass!"}</pre>
        <h3 id="result-heading-0"></h3>
        <pre id="result-0"></pre>

        <h2>‚ÑπÔ∏è <span id="test-uri-1">GET http://localhost:4200/api/1/users</span></h2>
        <a href="http://localhost:4200/api/1/users" target="_new">http://localhost:4200/api/1/users</a>
        <h3 id="result-heading-1"></h3>
        <pre id="result-1"></pre>

        <h2>‚ÑπÔ∏è <span id="test-uri-2">GET http://localhost:4200/api/1/fs/shared%2Fzips.json</span></h2>
        <a href="http://localhost:4200/api/1/fs/shared%2Fzips.json" target="_new">‚ö†Ô∏è  Large file: http://localhost:4200/api/1/fs/shared%2Fzips.json</a>
        <h3 id="result-heading-2"></h3>
        <pre id="result-2"></pre>
    </body>
</html>